# multi_pair_backtest_rs
支持多种交易对的量化交易回测框架
## 目录架构
```
- doc // 文档
- src
    - bin // 可执行文件入口
    - strategy // 策略
        - strategy_order // 策略订单 及 订单管理器
        - strategy_trading_pair // 策略交易对 及 交易对管理器
    - runner // 执行器
        - strategy_runner // 回测执行器
            - runner_order // 执行器订单 及 订单管理器
            - runner_trading_pair // 执行器交易对 及 交易对管理器
            - runner_data_manager // 执行器数据管理器
        - okx_runner // 实盘执行器 对接okx
        - binance_runner // 实盘执行器 对接bn
    - order
        - order_enum // 订单公共属性枚举
    - data // 数据管理
        - db // 数据库连接
        - kline // k线
        - funding_rate // 资金费率
    - assert // 资产管理
        - trading_pair // 交易对
        - assert // 资产 及 资产管理器
    - protocol // 数据传输协议
```
## todolist(log)
### 20250417
 - [x] 回测数据选择
   - Mk1回测执行速度越1~3条k线/s 快速回测时尽量选择合适数量的k线 建议回测1天的数据（1440条k线，约耗时10分钟）
   - 回测起始的价格尽量一致，建议选择价格为10W左右，方便计算资产和收益率。
   - 选择周期:回测周期(东八区)'2025-01-27 13:40:00' and '2025-01-28 24:22:00'
 - 回测执行效率问题
   - 问题表现：回测过程中执行效率随着数据规模扩大、执行过程进展，会逐渐变慢。
   - 原因：数据积累
   - [x] 优化方案1) 订单rollup: 在做资产统计时将多个订单合并（主要是已完成订单中的fee asset）
   - [ ] todo 优化方案2) 输入数据拆分，从DB读取数据时按时间分片，只读取一小段时间（比如1天）的数据，减少BTree的数据量，从而提高读写速度。
   - [ ] todo 优化方案3) 输出数据拆分，将DataLog数据定期做持久化，在内存中保留rollup数据，将明细数据定期append至磁盘文件，同时可以将输出数据的粒度细化。
 - Mk1策略优化
   - 问题1) 资金利用率不足
     - 从手续费（1个月手续费仅185USDT）可以看出
     - 解决方案：
       1. 改用动态调仓策略(即升级至Mk3)
       2. 加入弹性反馈，即允许仓位在一定幅度内变化（每一笔交易后的仓位可能更加偏离目标仓位），而不是必须保证每一笔交易后的仓位均相目标仓位靠近。
   - 问题2) 收益率过低
     - 订单间的价格差较小，mk1的等仓位策略会导致开仓平仓订单的利差过低（甚至低于手续费）
     - 解决方案：
       1. 引入策略订单，建立开仓订单和平仓订单之间的映射，避免止损(不止损)。
       2. 设置最小止盈，保证开仓订单和平仓订单的利差高于手续费(有效止盈)。
### 20250424 - Mk2开发中
 - [x] ~~计算效率问题~~
   - **效率问题主要原因是挂单量较高导致，可以通过调整参数来限制挂单量来解决。**
   - 原因：
     1. ~~由于引入了策略订单对（StrategyOrder），平仓单的价格必须根据已开仓订单来配置；而StrategyOrderManager中的OpenedOrders集合仅存储Uuid，需要进一步跳转才能获取到对应的StrategyOrder，此处的时间复杂度较高。~~
     2. （已解决）由于代码逻辑问题，导致平仓单挂单过密，计算量偏高。
   - 改进方案1：将StrategyOrderManager中的OpenedOrders集合的value从Uuid改为&StrategyOrder
   - 改进方案2：给StrategyOrderManager新增一个方法，用于返回一个StrategyOrder的数组（计算效率可能没差异）
 - 币价上涨过程中 仓位占比下跌过快 & 特殊情况下 现金价格与资产价格之和会发生突变（凭空多出很多现金）
   - [x] 原因1：（凭空多出很多现金）计算平仓单价格时 数值溢出 导致挂单价格为负数
   - [x] 原因2：（卖单挂单过于密集）逻辑问题导致卖单均以最低价格进行挂单
   - [x] 原因3：（卖单泄露）未执行的卖单没能成功地cancel掉
     - 解决方案：
       1. 添加统计指标，统计runner处理每条k线处理的挂单量，处理之后的挂单量，runner接受strategy挂单后的挂单量。  
       2. debug
   - [x] 原因4：（原因3的父级）StrategyOrderManager溢出-部分StrategyOrder没能被正确地Cancel掉 导数挂单积累
   - [x] 原因5：close订单和open订单的quantity不一致 需要将close订单的quantity强制修改为open订单的quantity
 - [x] python可视化程序 需要添加“交易量”相关数据
 - [x] 手续费结算问题
   - 描述：“累计手续费”会随着价格变化而变化
   - 原因：卖单手续费在结算时以基础资产计价，在展示时以计价资产计价。
   - 改进方案：在结算时改为基础资产计价。
 - [x] 通讯协议Bug
   - StrategyOrder无法将已挂单的Close单和Open单进行关联，原因是通讯协议中没有将StrategyOrder的id进行回传。
### 20250424 - Mk2开发完成 Mk3开发中
 - [ ] ~~统计未平仓订单数~~
   - 工作量较大，需要修改TStrategy
 - [ ] close订单挂单价格密度过高
   - ~~需要在完成open订单时，将相同（相近）开仓价格的订单进行梯度划分，open时间越晚的订单，其最低平仓价越高。~~
   - ~~固定仓位的挂单策略，会导致不挂单区间较大，挂单区间的密度过大。~~
     - ~~需要允许仓位在较大幅度内波动~~
 - [ ] open与close不平衡
   - open订单少量多次，close订单大量少次（集中大规模平仓）
   - 实际仓位占比一定会偏高
   - 解决方案：
     - 1）从“只做多”改为“多空对冲”；
     - 2）不再限制“仓位”，转而控制“多空比”和“杠杆率”。（需要保证仓位在0%~100%之间，否则存在爆仓风险）
 - [x] 细化回测指标
   - 新增“最高买单价格”和“最低卖单价格”指标
### 20250428 - Mk3开发完成
 - [ ] 优化：固定平单价格。
   - StrategyOrder在Opened之后直接计算最低平单价格，而不是在挂单时计算最低平单价格。
   - 避免分钟级别小幅波动导致订单频繁以最低价格平仓
   - 目的：提高收益率
 - [ ] 可视化优化：卖一价格过高
   - 超过盘口挂单价格区间的卖一，不予挂单。