# multi_pair_backtest_rs
支持多种交易对的量化交易回测框架
## 核心功能简介
 - 量化交易回测系统
 - 基于反馈控制、牛市时做趋势、熊市时做波动的量化交易策略
### 核心功能详解
 - 交易策略：
   - **基于反馈控制**
     - 使用反馈控制策略，将用户仓位控制在给定值。
     - **仅支持做多**
       - 在做多场景下，下跌买入加仓，上涨卖出减仓。
       - 盈利：低买高卖。
       - 模型收敛：加仓上涨，减仓下跌。
     - **不支持做空**：
       - 在做空场景下，如果低买高卖，则模型不收敛（下跌买入减仓，上涨卖出加仓，是正反馈模型）。
       - 在做空场景下，如果要模型收敛，则会产生亏损（下跌卖出加仓，上涨买入减仓，低卖高买产生亏损）。
   - 牛市时做趋势
     - 主仓做趋势
       - 仅做多
       - 在宏观价格较低时提高仓位，宏观价格较高时降低仓位。
     - 副仓做波动
       - 仅做多
       - 高频动态调整仓位，局部价格较低时提高仓位，局部价格较高时降低仓位。
   - 熊市时做波动
     - 多空对冲
       - 同时开启多仓和空仓
         - 多仓做波动，高频动态调整仓位，局部价格较低时提高仓位，局部价格较高时降低仓位。
         - 空仓做对冲，保持仓位和多仓一致。
       - 仓位占比控制
         - 基于反馈控制策略，先控制多仓仓位，再控制空仓仓位。
         - 多仓仓位：
           - 单边趋势时降低仓位，震荡趋势时提高仓位。
           - 熊市时，多仓仓位会持续降低，需要通过不断补仓来控制仓位。
           - 多仓的每笔平仓单不要求一定能盈利（大概率不能盈利），必要时需要强制平仓。
         - 空仓仓位：
           - 空仓仓位需要与多仓仓位保持一致。
           - 熊市时，空仓仓位会持续降低，需要通过不断补仓来控制仓位。
           - 空仓的每笔平仓单不要求一定能盈利（大概率能盈利），必要时需要强制平仓。
   - 如何制定目标仓位：
     - 大趋势用拟合模型、小趋势用概率模型
       - 大趋势：基于回归拟合的解析模型
       - 小趋势：基于小波变换的概率模型
     - 需给定最高仓位（牛市仓位）、最低仓位（熊市仓位）
       - 牛市仓位：
         - 牛市做多期间允许的最高仓位。
         - 永远不能满仓：不建议设置为100%，因为需要一定的波动空间。
       - 熊市仓位：
         - 熊市期间波动仓位的目标仓位值，该值越高，允许波动的空间就越大，对应的风险和获利空间就越大。
       - 如何进行牛熊转换：
         1. 牛市前期建仓：逐渐将多仓从熊市仓位提高至牛市仓位。
         2. 牛市末期减仓：逐渐将多仓从牛市仓位降低至熊市仓位（必要时强制平仓）。
         3. 熊市初期构建波动仓位：逐渐将空仓从0提高至熊市仓位。
         4. 熊市末期降低波动仓位：逐渐将空仓从熊市仓位降低至0（必要时强制平仓）。
## 目录架构
```
- doc // 文档
- src
    - bin // 可执行文件入口
    - strategy // 策略
        - strategy_order // 策略订单 及 订单管理器
        - strategy_trading_pair // 策略交易对 及 交易对管理器
    - runner // 执行器
        - strategy_runner // 回测执行器
            - runner_order // 执行器订单 及 订单管理器
            - runner_trading_pair // 执行器交易对 及 交易对管理器
            - runner_data_manager // 执行器数据管理器
        - okx_runner // 实盘执行器 对接okx
        - binance_runner // 实盘执行器 对接bn
    - order
        - order_enum // 订单公共属性枚举
    - data // 数据管理
        - db // 数据库连接
        - kline // k线
        - funding_rate // 资金费率
    - assert // 资产管理
        - trading_pair // 交易对
        - assert // 资产 及 资产管理器
    - protocol // 数据传输协议
```
## todolist(log)
### 20250417
 - [x] 回测数据选择
   - Mk1回测执行速度越1~3条k线/s 快速回测时尽量选择合适数量的k线 建议回测1天的数据（1440条k线，约耗时10分钟）
   - 回测起始的价格尽量一致，建议选择价格为10W左右，方便计算资产和收益率。
   - 选择周期:回测周期(东八区)'2025-01-27 13:40:00' and '2025-01-28 24:22:00'
 - 回测执行效率问题
   - 问题表现：回测过程中执行效率随着数据规模扩大、执行过程进展，会逐渐变慢。
   - 原因：数据积累
   - [x] 优化方案1) 订单rollup: 在做资产统计时将多个订单合并（主要是已完成订单中的fee asset）
   - [ ] todo 优化方案2) 输入数据拆分，从DB读取数据时按时间分片，只读取一小段时间（比如1天）的数据，减少BTree的数据量，从而提高读写速度。
   - [ ] todo 优化方案3) 输出数据拆分，将DataLog数据定期做持久化，在内存中保留rollup数据，将明细数据定期append至磁盘文件，同时可以将输出数据的粒度细化。
 - Mk1策略优化
   - 问题1) 资金利用率不足
     - 从手续费（1个月手续费仅185USDT）可以看出
     - 解决方案：
       1. 改用动态调仓策略(即升级至Mk3)
       2. 加入弹性反馈，即允许仓位在一定幅度内变化（每一笔交易后的仓位可能更加偏离目标仓位），而不是必须保证每一笔交易后的仓位均相目标仓位靠近。
   - 问题2) 收益率过低
     - 订单间的价格差较小，mk1的等仓位策略会导致开仓平仓订单的利差过低（甚至低于手续费）
     - 解决方案：
       1. 引入策略订单，建立开仓订单和平仓订单之间的映射，避免止损(不止损)。
       2. 设置最小止盈，保证开仓订单和平仓订单的利差高于手续费(有效止盈)。
### 20250424 - Mk2开发中
 - [x] ~~计算效率问题~~
   - **效率问题主要原因是挂单量较高导致，可以通过调整参数来限制挂单量来解决。**
   - 原因：
     1. ~~由于引入了策略订单对（StrategyOrder），平仓单的价格必须根据已开仓订单来配置；而StrategyOrderManager中的OpenedOrders集合仅存储Uuid，需要进一步跳转才能获取到对应的StrategyOrder，此处的时间复杂度较高。~~
     2. （已解决）由于代码逻辑问题，导致平仓单挂单过密，计算量偏高。
   - 改进方案1：将StrategyOrderManager中的OpenedOrders集合的value从Uuid改为&StrategyOrder
   - 改进方案2：给StrategyOrderManager新增一个方法，用于返回一个StrategyOrder的数组（计算效率可能没差异）
 - 币价上涨过程中 仓位占比下跌过快 & 特殊情况下 现金价格与资产价格之和会发生突变（凭空多出很多现金）
   - [x] 原因1：（凭空多出很多现金）计算平仓单价格时 数值溢出 导致挂单价格为负数
   - [x] 原因2：（卖单挂单过于密集）逻辑问题导致卖单均以最低价格进行挂单
   - [x] 原因3：（卖单泄露）未执行的卖单没能成功地cancel掉
     - 解决方案：
       1. 添加统计指标，统计runner处理每条k线处理的挂单量，处理之后的挂单量，runner接受strategy挂单后的挂单量。  
       2. debug
   - [x] 原因4：（原因3的父级）StrategyOrderManager溢出-部分StrategyOrder没能被正确地Cancel掉 导数挂单积累
   - [x] 原因5：close订单和open订单的quantity不一致 需要将close订单的quantity强制修改为open订单的quantity
 - [x] python可视化程序 需要添加“交易量”相关数据
 - [x] 手续费结算问题
   - 描述：“累计手续费”会随着价格变化而变化
   - 原因：卖单手续费在结算时以基础资产计价，在展示时以计价资产计价。
   - 改进方案：在结算时改为基础资产计价。
 - [x] 通讯协议Bug
   - StrategyOrder无法将已挂单的Close单和Open单进行关联，原因是通讯协议中没有将StrategyOrder的id进行回传。
### 20250424 - Mk2开发完成 Mk3开发中
 - [x] ~~统计未平仓订单数~~
   - 工作量较大，需要修改TStrategy
 - [x] close订单挂单价格密度过高
   - ~~需要在完成open订单时，将相同（相近）开仓价格的订单进行梯度划分，open时间越晚的订单，其最低平仓价越高。~~
   - ~~固定仓位的挂单策略，会导致不挂单区间较大，挂单区间的密度过大。~~
     - ~~需要允许仓位在较大幅度内波动~~
 - [ ] open与close不平衡
   - open订单少量多次，close订单大量少次（集中大规模平仓）
   - 实际仓位占比一定会偏高
   - 解决方案：
     - 1）从“只做多”改为“多空对冲”；
     - 2）不再限制“仓位”，转而控制“多空比”和“杠杆率”。（需要保证仓位在0%~100%之间，否则存在爆仓风险）
 - [x] 细化回测指标
   - 新增“最高买单价格”和“最低卖单价格”指标
### 20250428 - Mk3开发完成
 - [x] 优化：固定平单价格。
   - StrategyOrder在Opened之后直接计算最低平单价格，而不是在挂单时计算最低平仓价格。
   - 当开仓单堆积时，逐步提高平仓单的最低平仓价格。
   - 避免分钟级别小幅波动导致订单频繁以最低价格平仓
   - 目的：提高收益率
 - [x] 可视化优化：卖一价格过高
   - 超过盘口挂单价格区间的卖一，不予挂单。
 -  添加指标： 
   - [ ] 预期收益：sum(已开仓未平仓订单的 (最低平仓价格 - 开仓价格) * quantity - 预期手续费)
   - [ ] 已实现收益：sum(已平仓订单的 (平仓价格 - 开仓价格) * quantity - 实际手续费)
### 20250509 - Mk4设计中
 - 计算 预期价格-仓位 映射：使用预期价格的一阶导数和二阶导数来计算
   - [x] 计算预期价格的一阶导数和二阶导数：使用差分法
   - [ ] 根据一阶导数和二阶导数，计算仓位：使用相位角度。
     - 先将一阶导数和二阶导数进行归一化（转化为相同量纲？）
     - 将一阶导数作为横坐标，二阶导数作为纵坐标，计算每一时刻的状态所表示的向量。
     - 根据向量与坐标的夹角，计算仓位：
       - [x] 计算策略1：（左侧交易）
         - 第一象限(0°~90°加速上涨)持有多仓，保持仓位最高。
         - 第四象限(270°~360°减速上涨)平多做空，仓位持续降低。
         - 第三象限(180°~270°加速下跌)持有空仓，保持仓位最低。
         - 第二象限(90°~180°减速下跌)平空做多，仓位持续提高。
       - [ ] 计算策略2：（右侧交易，降低回撤）
         - 在第四象限和第三象限交界处(270°附近)平多做空，设置仓位置换区间，在第四象限进行平多，在第三象限进行做空。
         - 在第二象限和第一象限交界处(90°附近)平空做多，设置仓位置换区间，在第二象限进行平空，在第一象限进行做多。
     - todo 相位角度-仓位 映射
 - 长时间尺度回测优化
   - [ ] map-reduce
     - map: 时间尺度分段，并发执行；每段需确定初始仓位。
     - reduce：将多段结果进行统一，汇总数据。
   - [ ] 数据展示
     - 只考虑每段的收益率，不考虑具体资产量。
     - 数据压缩：将分钟粒度的折现数据，上卷至日粒度，以k线形式展示。
- [ ] 多空策略
    - 同时支持做多和做空，使用\[-100%,0\]表示空仓，\[0, +100%\]表示多仓。
    - 支持仓位为负数的情况-\[-100%,0\]
    - 挂买单时，优先平空仓，其次开多仓。
    - 挂卖单时，优先平多仓，其次开空仓。
    - 需要同时考虑“开仓资金占比”和“仓位”
        - 开仓资金占比-已开仓未平仓的资金占总资产的比例，可能大于100%。
        - 仓位-基础资产占总资产的比例，介于0%和100%之间。
- [ ] **做空问题：做空时无法收敛 反馈控制失效！**
  - [x] debug - 目标仓位为负数时无法开空单
    - 原因是资产的split不允许拆分后出现负数
  - [ ] debug - 做空时平仓单过多 and 平空单价格高于开空单 导致实际仓位无法收敛至目标仓位
    - 原因是做空并且仓位过低时，只能等待价格下降来提升仓位，无法挂买单来等待价格下降（如果卖单价格过低会导致直接成交，进一步降低仓位）。
 - [x] 优化script逻辑 充分利用泛型
 - [ ] PID逻辑选择：
   1. 给定目标仓位(hard目标仓位)时进行PID调整，获得soft目标仓位，之后的所有挂单根据soft目标仓位进行调整。
   2. 使用soft目标仓位作为第一个挂单的目标仓位，随后的每一个挂单，需要考虑上个挂单完成后的实际仓位，再使用PID生成新的soft目标仓位。
 - [ ] 做空时如何计算实际仓位