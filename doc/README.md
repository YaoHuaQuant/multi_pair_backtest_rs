# BTC Quant-V2
---

## Desc

- BTC 量化分析/交易 系统

### 与V1的差异
- 编程语言
  - V1使用python
  - V2使用rust
- 使用多种标的物
  - V1只针对单个标的物（U本位合约）
  - V2考虑多个标的物的组合（U本位合约做空+现货+币本位合约做多）
  - V2同时考虑合约的资金费率
- 策略优化
  - 仓位控制策略优化
  - 定价策略优化

## 产品
### 需求
 - 主要目标：资产增值，在保障资金安全的前提下，尽可能提高收益率。
 - 数据报表展示
   - 交易数据 汇总/明细
   - 分析数据 汇总/明细
     - 用户自定义分析指标
 - 用户操作：
   - 紧急熔断：暂停交易、一键平仓、降低杠杆、锁定最大仓位 等
### 架构
 - UI
   - web端
   - 移动端
 - 功能
   - 数据展示
     - 交易数据
     - 分析数据
   - 用户操作
     - 添加指标
     - 紧急熔断
       - 仓位控制：暂停交易、一键平仓、降低杠杆、锁定最大仓位 等
       - 订单控制：挂单、撤单、调整价格

## 技术架构
 - UI
   - web端
   - 移动端
 - 采集模块
   - 存储：clickhouse
   - 采集：对接交易所api
   - 指标：
     - 币本位合约-价格、交易量、资金费率
     - U本位合约-价格、交易量、资金费率
     - 现货-价格、交易量
 - 分析模块
   - 自定义指标
   - 数据分析
 - 策略模块
   - 备注：策略模块使用事件驱动模型，仅在特定事件（比如定时事件）时被唤醒执行。
   - 资金管理-仓位、杠杆
   - 订单管理
     - 订单状态：待开仓、已开仓、已平仓、已取消
 - 交易模块
   - 回测模拟交易
   - 实盘交易

## 指标
 - 现有指标
   - 最大振幅
     - 定义：
       - 最大振幅（绝对）=最高价-最低价
       - 最大振幅（相对）=（最高价-最低价）/（市价 or 开盘价格 or 收盘价格）
   - 20日历史波动率（HV）
     - 定义：历史波动率是基于过去一段时间内资产价格的标准差，反映资产价格的波动程度。
   - 布林带宽度（BBW）
     - 布林带宽度是布林带上轨和下轨之间的宽度（4倍标准差），反映市场波动性。
   - 隐含波动率（IV）
     - 通过期权市场价格和Black-Scholes模型反推得出，能够反映市场对未来波动率的预期。
   - 强弱指数（RSI）
   - 平均真实波幅（ATR）
   - 真实波幅（TR）
 - 自定义指标
   - 价格运动路程长度
     - 定义：
       1. 在较细的时间粒度内（比如1分钟），统计 **(最高价-最低价)\*2 - abs(开盘价-收盘价)**
       2. 在较粗的时间粒度内（比如1天），统计周期内细粒度区间的“价格运动路程长度”并**求和**，作为该周期的“价格运动路程长度”。
     - 含义：统计时间内价格变动的绝对值的最小值
   - 价格运动路程速率
       - 定义：
           1. 价格运动路程长度/统计时间周期
       - 含义：统计时间内价格变动的绝对值的最小速率
   - 价格运动路程百分比
       - 定义：
           1. 价格运动路程长度/开盘价
       - 含义：统计时间内 价格变动的绝对值的最小值 占 当前价格 的百分比
   - **价格运动路程百分比速率(行进速率)**
       - 定义：
           1. 价格运动路程百分比/统计时间周期
       - 含义：统计时间内 价格运动路程百分比 的变动速率
   - 平均价格运动路程百分比（最大期望收益百分比）
       - 定义：
         1. 在较细的时间粒度内（比如1分钟），统计 价格运动路程百分比
         2. 在较粗的时间粒度内（比如1天），统计周期内细粒度区间的“价格运动路程百分比”并**求和**，作为该周期的“平均价格运动路程百分比”。
       - 含义：
         1. 统计时间内 价格运动路程百分比 的均值
         2. 如果在每个细时间粒度（比如1分钟）内进行等额本金定投，能够获得的最大期望收益百分比。
   - **平均价格运动路程百分比速率（最大期望收益率）**
       - 定义：
         1. 平均价格运动路程百分比/统计时间周期
       - 含义：
         1. 统计时间内价格百分比变动的速率
         2. 如果在每个细时间粒度（比如1分钟）内进行等额本金定投，能够获得的最大期望收益率。 
   - **折叠率**
     - 定义：在较粗的时间粒度内（比如1天），价格运动路程长度/最大振幅
     - 含义：
       - “折叠率”是路程长度总和除以最大振幅，这个比值可能用来衡量价格在一天内的波动效率或密集程度。如果比值高，说明价格在一天内频繁波动但整体振幅不大，可能处于整理阶段；比值低则可能表明价格波动集中在少数时间段，趋势明显。
       - 折叠率越高，越适合做多波动率。
     - 创新点：该比值可反映市场参与者的交易活跃度。例如，高比值（路程长但振幅小）可能表明多空双方频繁拉锯，但未形成明确趋势；低比值则可能对应单边行情。

## 策略优化
 - 仓位控制优化:
   - V1中，根据当前BTC价格，强制限制最大的仓位比例。
   - V2中，考虑使用 凯利公式+控制策略，动态地调整仓位。
     - 凯利公式：
       - 定义：仓位占比对投资策略的EV有影响，使用赔率、胜率，能够计算出EV最高的仓位占比-“最优仓位占比”。
       - 解释：
         - 赔率：根据止盈点位计算，而止盈点位由人工设定获得。在不上杠杆的前提下，本策略不进行止损操作。
         - 胜率：基于历史数据计算得出，具体计算公式参考期权定价模型。
         - 提高收益的策略：低价&高赔率
           - 在固定赔率的前提下，BTC价格越低，开仓的 胜率/单位时间收益率 越高。
           - 在固定开仓价格的前提下，赔率越低（止盈点位越低），开仓的 胜率/单位时间收益率 越高。
     - 控制策略：
       - 控制目标：最优仓位占比
         - 如何计算“最优仓位占比”：基于“目标价格（创新高）”和“波动率”
       - 输入信号：实际仓位占比
       - 控制量：订单密度/订单价格
       - 控制算法：PID反馈控制
 - 订单价格分布优化：
   - V1中，开仓订单的价格是在开仓区间内均匀分布的，而平仓订单的价格不是均匀分布的，而是基于开仓价格进行动态调整的。
   - V2中，考虑将平仓订单的价格，调整成在平仓区间内均匀分布。
 - 模式识别&参数优化
   - 模式识别：
     - 根据相关参数，将BTC的k线走势进行划分，比如分类为 上涨模式、震荡模式、下跌模式。
   - 参数优化：
     - 在不同模式下进行优化，分别计算出收益率最高的参数。

## 数据分析
 - 数据分析角度：
    1. **傅里叶变换/拉普拉斯变换**
       - 将比特币价格走势，视为 事件驱动（低频高振幅） 与 随机扰动（高频低振幅） 的叠加。
       - 使用拉普拉斯变换，将 事件驱动因素 与 随机扰动因素 进行解耦。
       - 事件驱动因素 用于指导 标的物选择策略 和 仓位控制策略。
         - **标的物选择策略**
           - 金融资产物分为4类：U本位做空合约（short）、USDT、比特币现货（BTC）、币本位做多合约（long）
           - 交易对有3个：U本位做空合约/USDT、BTC/USDT、币本位做多合约/BTC
           - 仓位有3个：
             - 一级仓位：
               - 父仓位，其子仓位分别是U仓位和币仓位。
               - **“一级仓位”指代“一级币仓位”**
               - 计算方式：
                 - 一级币仓位（做多） = (BTC现货价值 + BTC币本位做多合约价值) / 总资产
                 - 一级U仓位（看空） = (USDT总量 + U本位做空合约价值) / 总资产
                 - 有恒等式：一级币仓位 + 一级U仓位 = 1
             - 二级仓位：
               - 二级币仓位（做多） = BTC币本位做多合约价值 / (BTC现货价值 + BTC币本位做多合约价值)
               - 二级U仓位（做空） = U本位做空合约价值 / (USDT总量 + U本位做空合约价值)
           - 标的物选择策略：
             - 价格影响
               - 价格越低：
                 - 一级仓位越重
                 - 二级币仓位越重
                 - 二级U仓位越轻
               - 价格越高：
                 - 一级仓位越轻
                 - 二级币仓位越轻
                 - 二级U仓位越重
             - 涨跌趋势（价格的导数）影响
               - xxx
         - **仓位控制策略**
           - 价格影响
             - 价格越低，long仓位越重，short仓位越轻。
             - 价格越高，long仓位越轻，long仓位越重。
           - 涨跌趋势（价格的导数）影响
             - 下跌过程中减少long仓位（减少被套资金量）
               - 提高close long密度，降低open long密度。
             - 上涨过程中提高long仓位（增大收益），减少short仓位（避险）
               - 提高open long密度，降低close long密度。
               - 提高close short密度，降低open short密度。
             - 震荡过程中同时提高long和short仓位（做多波动率，根据资金费率调整long和short比例）
               - open long 约等于 close short
               - open short 约等于 close long
               - 基于资金费率选择long或者short
       - 随机扰动因素 用于指导定价策略。
         - 根据随机扰动振幅，调整最低止盈收益率。
           - 最低止盈收益率：随机扰动振幅越大，最低止盈收益率越高。
